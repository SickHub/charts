version: 2.1
aliases:
  - &chart-testing
    - image: quay.io/helmpack/chart-testing
  - &helm
    - image: alpine/helm
  - &docker-dind
    - image: docker:dind
  - &lint
    - checkout
    - run:
        name: Lint chart
        command: |
          ct lint --charts=drpsychick/cronjobs
  - &deploy
    - checkout
    - setup_remote_docker:
        version: 20.10.2
    - run:
        name: Install helm
        command: |
          apk --no-cache add curl
          curl -sSLo helm-v${HELM_VERSION}.tgz "https://get.helm.sh/helm-v${HELM_VERSION}-linux-amd64.tar.gz"
          sha256sum helm-v${HELM_VERSION}.tgz |grep "${HELM_CHECKSUM}" || exit 1
          tar xvzf helm-v${HELM_VERSION}.tgz
          chmod +x linux-amd64/helm
          mv linux-amd64/helm /usr/local/bin/helm
    - run:
        name: Lint chart
        command: |
          docker run --rm --network host --interactive --tty --name chart-test \
            --volume $PWD:/workdir --workdir /workdir \
            quay.io/helmpack/chart-testing \
            ci lint --charts=drspychick/cronjobs
    - run:
        name: Package chart
        command: |
          helm dep update drpsychick/cronjobs
          helm package drpsychick/cronjobs
    - run:
        name: Install kind
        command: |
          curl -sSLo kind-${KIND_VERSION} "https://github.com/kubernetes-sigs/kind/releases/download/${KIND_VERSION}/kind-linux-amd64"
          chmod +x kind-${KIND_VERSION}
          mv kind-${KIND_VERSION} /usr/local/bin/kind
    - run:
        name: Create and start kind cluster
        command: |
          echo "kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
          - role: worker" > kind-config.yaml
          kind delete cluster --name "$CLUSTER_NAME" --quiet || true
          kind create cluster --name "$CLUSTER_NAME" --kubeconfig $KIND_KUBECONFIG \
            --config kind-config.yaml --image "kindest/node:$KIND_K8S_VERSION" \
            --wait $WAIT_FOR_CONTROLPLANE
    - run:
        name: Install on kind
        command: |
          docker run --rm --network host --interactive --tty --name chart-test \
            --volume $PWD:/workdir --workdir /workdir \
            quay.io/helmpack/chart-testing \
            ls -la
          docker run --rm --network host --interactive --tty --name chart-test \
            --env KUBECONFIG=/workdir/$KIND_KUBECONFIG \
            --volume $PWD:/workdir:ro --workdir /workdir \
            quay.io/helmpack/chart-testing \
            ct install --namespace $NAMESPACE --charts=drpsychick/cronjobs
jobs:
  lint:
    docker: *chart-testing
    steps: *lint
  deploy:
    docker: *docker-dind
    environment:
      KIND_VERSION: v0.10.0
      KIND_K8S_VERSION: v1.20.2@sha256:8f7ea6e7642c0da54f04a7ee10431549c0257315b3a634f6ef2fecaaedb19bab
      KIND_KUBECONFIG: test-charts.kubeconfig
      CLUSTER_NAME: test-charts
      WAIT_FOR_CONTROLPLANE: 60s
      NAMESPACE: default
      HELM_VERSION: 3.5.3
      HELM_CHECKSUM: 2170a1a644a9e0b863f00c17b761ce33d4323da64fc74562a3a6df2abbf6cd70
    steps: *deploy

workflows:
  version: 2
  chart-test:
    jobs:
      - lint
      - deploy
