version: 2.1
aliases:
  - &chart-testing
    - image: quay.io/helmpack/chart-testing
  - &helm
    - image: alpine/helm
  - &docker-dind
    - image: docker:dind
  - &lint
    - checkout
    - run:
        name: Lint chart
        command: |
          cd drpsychick
          ct lint --chart-dirs=.
  - &package
    - checkout
    - run:
        name: Package chart
        command: &package-chart |
          cd drpsychick
          helm dep update cronjobs
          helm package cronjobs
  - &deploy
    - checkout
    - setup_remote_docker:
        version: 20.10.2
    - run:
        name: Install helm
        command: |
          apk no-cache add curl
          curl -L https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz |tar xvz
          chmod +x linux-amd64/helm
          mv linux-amd64/helm /usr/local/bin/helm
    - run:
        name: Package chart
        command: *package-chart
    - run:
        name: Install kind
        command: |
          curl -sSLo /tmp/kind "https://github.com/kubernetes-sigs/kind/releases/download/${KIND_VERSION}/kind-linux-amd64"
          chmod +x /tmp/kind
          mkdir -p /usr/local/bin
          mv /tmp/kind /usr/local/bin/kind
    - run:
        name: Start kind
        command: |
          echo "kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
          - role: worker" > kind-config.yaml
          kind delete cluster --name "$CLUSTER_NAME" > /dev/null 2>&1 || true
          kind create cluster --name "$CLUSTER_NAME" --kubeconfig $KUBECONFIG_PATH \
            --config kind-config.yaml --image "kindest/node:$NODE_K8S_VERSION" --wait $WAIT_FOR_CONTROLPLANE
    - run:
        name: Install on kind
        command: |
          docker run --rm --network host --interactive --tty --name chart-test \
            --volume $PWD/kind-config.yaml:/root/.kube/config \
            --volume $PWD:/workdir --workdir /workdir \
            quay.io/helmpack/chart-testing \
            ct install --namespace $NAMESPACE --chart-dirs=drpsychick
jobs:
  lint:
    docker: *chart-testing
    steps: *lint
  package:
    docker: *helm
    steps: *package
  deploy:
    docker: *docker-dind
    environment:
      KIND_VERSION: v0.10.0
      KIND_K8S_VERSION: v1.20.2@sha256:8f7ea6e7642c0da54f04a7ee10431549c0257315b3a634f6ef2fecaaedb19bab
      CLUSTER_NAME: test-charts
      WAIT_FOR_CONTROLPLANE: 60s
      KUBECONFIG_PATH: $HOME/test-chart.kubeconfig
      NAMESPACE: default
    steps: *deploy

workflows:
  version: 2
  chart-test:
    jobs:
      - lint
      - package
      - deploy
